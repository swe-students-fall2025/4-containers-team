services:
    mongodb:
        image: mongo:latest
        container_name: mongodb
        ports:
            - "27017:27017"
        volumes:
            - mongodb_data:/data/db
        environment:
            - MONGO_INITDB_DATABASE=ml_data
        networks:
            - ml_network
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5

    machine-learning-client:
        build:
            context: ./machine-learning-client
            dockerfile: Dockerfile
        container_name: ml-client
        depends_on:
            mongodb:
                condition: service_healthy
        environment:
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DATABASE=ml_data
            - COLLECTION_INTERVAL=60
        networks:
            - ml_network
        restart: unless-stopped

    web-app:
        build:
            context: ./web-app
            dockerfile: Dockerfile
        container_name: web-app
        ports:
            - "8000:5000"
        depends_on:
            mongodb:
                condition: service_healthy
        environment:
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DATABASE=ml_data
            - PORT=5000
        networks:
            - ml_network
        restart: unless-stopped

volumes:
    mongodb_data:

networks:
    ml_network:
        driver: bridge
