services:
    mongodb:
        image: mongo:latest
        container_name: mongodb
        ports:
            - "27017:27017"
        volumes:
            - mongodb_data:/data/db
        environment:
            - MONGO_INITDB_DATABASE=proj4
        networks:
            - ml_network
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5

    machine-learning-client:
        build:
            context: ./machine-learning-client
            dockerfile: Dockerfile
        container_name: ml-client
        depends_on:
            mongodb:
                condition: service_healthy
        environment:
            - MONGO_URI=mongodb+srv://bcl9779_db_user:1234@proj4.72ayexj.mongodb.net/proj4?retryWrites=true&w=majority
            - MONGODB_DATABASE=proj4
            - COLLECTION_INTERVAL=10
        volumes:
            - uploads_data:/uploads
        networks:
            - ml_network
        restart: unless-stopped

    web-app:
        build:
            context: ./web-app
            dockerfile: Dockerfile
        container_name: web-app
        ports:
            - "8000:5000"
        depends_on:
            mongodb:
                condition: service_healthy
        environment:
            - MONGO_URI=mongodb+srv://bcl9779_db_user:1234@proj4.72ayexj.mongodb.net/proj4?retryWrites=true&w=majority
            - MONGODB_DATABASE=proj4
            - PORT=5000
        volumes:
            - uploads_data:/uploads
        networks:
            - ml_network
        restart: unless-stopped

volumes:
    mongodb_data:
    uploads_data:

networks:
    ml_network:
        driver: bridge