services:
    mongodb:
        image: mongo:latest
        container_name: mongodb
        ports:
            - "27017:27017"
        volumes:
            - mongodb_data:/data/db
        environment:
            - MONGO_INITDB_DATABASE=proj4
        networks:
            - ml_network
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5

    machine-learning-client:
        build:
            context: ./machine-learning-client
            dockerfile: Dockerfile
        container_name: ml-client
        depends_on:
            mongodb:
                condition: service_healthy
        environment:
            - MONGO_URI=${MONGO_URI:-}
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DATABASE=proj4
            - COLLECTION_INTERVAL=60
            - UPLOAD_DIR=/shared/uploads #Added upload directory env var
        volumes:
            - uploads_data:/shared/uploads #shared volume for uploads, allows us to access files uploaded via web-app
        networks:
            - ml_network
        restart: unless-stopped

    web-app:
        build:
            context: ./web-app
            dockerfile: Dockerfile
        container_name: web-app
        ports:
            - "8000:5000"
        depends_on:
            mongodb:
                condition: service_healthy
        environment:
            - MONGO_URI=${MONGO_URI:-}
            - MONGODB_HOST=mongodb
            - MONGODB_PORT=27017
            - MONGODB_DATABASE=proj4
            - PORT=5000
            - UPLOAD_FOLDER=/shared/uploads #Added an upload folder env var, lets us share the volume with ml-client
        networks:
            - ml_network
        volumes: #shared volume for uploads between web-app and ml-client
            - uploads_data:/shared/uploads
        restart: unless-stopped

volumes:
    mongodb_data:
    uploads_data:

networks:
    ml_network:
        driver: bridge
